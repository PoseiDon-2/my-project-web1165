(()=>{var e={};e.id=274,e.ids=[274],e.modules={53524:e=>{"use strict";e.exports=require("@prisma/client")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},55315:e=>{"use strict";e.exports=require("path")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},95346:e=>{"use strict";e.exports=require("timers")},82452:e=>{"use strict";e.exports=require("tls")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},87529:()=>{},39697:()=>{},62302:()=>{},30107:()=>{},47524:()=>{},86003:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var n={};r.r(n),r.d(n,{GET:()=>m,dynamic:()=>d});var o=r(49303),s=r(88716),a=r(60670),i=r(87070),u=r(72331),c=r(13477);let d="force-dynamic",l=new Map;async function m(e){let t=e.nextUrl.searchParams.get("userId");try{if(t){let e=`recommendations:${t}`,r=l.get(e);if(r&&Date.now()-r.timestamp<1e4)return console.log(`Returning cached recommendations for user ${t}`),i.NextResponse.json(r.data)}if(!t){console.log("No userId provided, using fallback recommendations");let e=(await u._.donationRequest.findMany({where:{status:"APPROVED",expiresAt:{gt:new Date}},orderBy:[{recommendationScore:"desc"},{supporters:"desc"},{urgency:"desc"},{createdAt:"desc"}],take:10,select:{id:!0,title:!0,description:!0,category:{select:{name:!0}},organizer:{select:{firstName:!0,lastName:!0}},urgency:!0,supporters:!0,latitude:!0,longitude:!0,targetAmount:!0,currentAmount:!0,images:!0,expiresAt:!0,createdAt:!0,recommendationScore:!0}})).map(e=>({...e,currentAmount:e.currentAmount.toString(),targetAmount:e.targetAmount?e.targetAmount.toString():null,supporters:e.supporters??0,latitude:e.latitude??null,longitude:e.longitude??null,daysLeft:e.expiresAt?Math.max(Math.ceil((e.expiresAt.getTime()-Date.now())/864e5),0):void 0,images:e.images?JSON.parse(e.images):null}));return i.NextResponse.json(e)}let e=await u._.user.findUnique({where:{id:t},include:{userinterest:{include:{category:!0}},userinteraction:{where:{entityType:{in:["DonationRequest","Story"]}}},donations:{include:{request:{include:{category:!0}}}},volunteerApplications:{include:{request:{include:{category:!0}}}},favorites:{include:{request:{include:{category:!0}}}}}});if(!e)return console.error("User not found for ID:",t),i.NextResponse.json({error:"User not found"},{status:404});let r=e.userinterest.filter(e=>e.category).map(e=>e.category.name),n=e.favorites.map(e=>e.request.category.name),o=e.favorites.map(e=>e.requestId),s=e.donations.map(e=>e.request.category.name),a=e.volunteerApplications.map(e=>e.request.category.name),d=e.latitude&&e.longitude?{lat:e.latitude,lng:e.longitude}:null,m=(await u._.relatedcategory.findMany({where:{categoryId:{in:await u._.category.findMany({where:{name:{in:r}},select:{id:!0}}).then(e=>e.map(e=>e.id))}},include:{category_relatedcategory_relatedCategoryIdTocategory:!0}})).map(e=>e.category_relatedcategory_relatedCategoryIdTocategory.name),p=[...new Set([...r,...n,...s,...a,...m])],g=await u._.user.findMany({where:{id:{not:t},userinterest:{some:{category:{name:{in:r}}}}},include:{favorites:{select:{requestId:!0}}},take:20}),y=[...new Set(g.flatMap(e=>e.favorites.map(e=>e.requestId)))],f=(await u._.donationRequest.findMany({where:{status:"APPROVED",id:{notIn:o},expiresAt:{gt:new Date},OR:[{category:{name:{in:p}}},{id:{in:y}}]},select:{id:!0,title:!0,description:!0,category:{select:{name:!0}},organizer:{select:{firstName:!0,lastName:!0}},urgency:!0,supporters:!0,latitude:!0,longitude:!0,targetAmount:!0,currentAmount:!0,images:!0,expiresAt:!0,createdAt:!0,recommendationScore:!0},take:50})).map(t=>{let o=t.recommendationScore||0;r.includes(t.category.name)&&(o+=.5),n.includes(t.category.name)&&(o+=.4),(s.includes(t.category.name)||a.includes(t.category.name))&&(o+=.3);let i=0;if(d&&t.latitude&&t.longitude){let e=function(e,t){let r=(t.lat-e.lat)*(Math.PI/180),n=(t.lng-e.lng)*(Math.PI/180),o=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e.lat*(Math.PI/180))*Math.cos(t.lat*(Math.PI/180))*Math.sin(n/2)*Math.sin(n/2);return 2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o))*6371}(d,{lat:t.latitude,lng:t.longitude});e<50?i=.3:e<100&&(i=.1),o+=i}y.includes(t.id)&&(o+=.25);let u=e.userinteraction.filter(e=>e.entityId===t.id&&"DonationRequest"===e.entityType).reduce((e,t)=>e+(t.weight||0),0);o+=u;let c="HIGH"===t.urgency?.3:"MEDIUM"===t.urgency?.1:0;o+=c;let l=Math.min((t.supporters||0)/50,.2);o+=l;let m=7>Math.ceil((Date.now()-t.createdAt.getTime())/864e5)?.1:0;return o+=m,console.log(`Score breakdown for ${t.id}:`,{baseScore:t.recommendationScore,categoryMatch:r.includes(t.category.name)?.5:0,favoriteMatch:n.includes(t.category.name)?.4:0,locationBonus:i,interactionScore:u,urgencyBonus:c,popularityBonus:l,newnessBonus:m,totalScore:o}),{...t,score:o,currentAmount:t.currentAmount.toString(),targetAmount:t.targetAmount?t.targetAmount.toString():null,supporters:t.supporters??0,latitude:t.latitude??null,longitude:t.longitude??null,daysLeft:t.expiresAt?Math.max(Math.ceil((t.expiresAt.getTime()-Date.now())/864e5),0):void 0,images:t.images?JSON.parse(t.images):null}}).filter(e=>e.score>0).sort((e,t)=>t.score-e.score).slice(0,10);if(t&&(l.set(`recommendations:${t}`,{data:f,timestamp:Date.now()}),setTimeout(()=>l.delete(`recommendations:${t}`),1e4)),console.log(`Recommendations for user ${t}:`,f.map(e=>({id:e.id,title:e.title,score:e.score}))),0===f.length){console.log("No recommendations found, using fallback");let e=await u._.category.findMany({orderBy:{donationRequests:{_count:"desc"}},take:3,select:{name:!0}}),t=(await u._.donationRequest.findMany({where:{status:"APPROVED",id:{notIn:o},expiresAt:{gt:new Date},category:{name:{in:e.map(e=>e.name)}}},select:{id:!0,title:!0,description:!0,category:{select:{name:!0}},organizer:{select:{firstName:!0,lastName:!0}},urgency:!0,supporters:!0,latitude:!0,longitude:!0,targetAmount:!0,currentAmount:!0,images:!0,expiresAt:!0,createdAt:!0,recommendationScore:!0},orderBy:[{recommendationScore:"desc"},{supporters:"desc"},{urgency:"desc"},{createdAt:"desc"}],take:10})).map(e=>({...e,currentAmount:e.currentAmount.toString(),targetAmount:e.targetAmount?e.targetAmount.toString():null,supporters:e.supporters??0,latitude:e.latitude??null,longitude:e.longitude??null,daysLeft:e.expiresAt?Math.max(Math.ceil((e.expiresAt.getTime()-Date.now())/864e5),0):void 0,images:e.images?JSON.parse(e.images):null}));return i.NextResponse.json(t)}return t&&(0,c.UI)(t,f),i.NextResponse.json(f)}catch(e){return console.error("Recommendation error:",e),i.NextResponse.json({error:"Failed to load recommendations",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/recommendations/donation-requests/route",pathname:"/api/recommendations/donation-requests",filename:"route",bundlePath:"app/api/recommendations/donation-requests/route"},resolvedPagePath:"D:\\testProject\\test-project\\app\\api\\recommendations\\donation-requests\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:f}=p,h="/api/recommendations/donation-requests/route";function x(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},72331:(e,t,r)=>{"use strict";r.d(t,{_:()=>o});var n=r(53524);let o=globalThis.prisma??new n.PrismaClient},13477:(e,t,r)=>{"use strict";r.d(t,{KI:()=>a,UI:()=>i});var n=r(90117);let o=null,s=[];function a(e){return o||(o=new n.xF(e,{cors:{origin:"*",methods:["GET","POST"]}})).on("connection",e=>{console.log("Client connected:",e.id),e.on("register",t=>{t.userId&&(s.push({socketId:e.id,userId:t.userId}),console.log(`User ${t.userId} registered to WebSocket`))}),e.on("disconnect",()=>{console.log("Client disconnected:",e.id);let t=s.findIndex(t=>t.socketId===e.id);t>-1&&s.splice(t,1)})}),o}function i(e,t){if(!o){console.error("WebSocket server not initialized");return}s.filter(t=>t.userId===e).forEach(r=>{o.to(r.socketId).emit("recommendations-update",{type:"recommendations-update",userId:e,recommendations:t})}),console.log(`Broadcasted recommendations to user ${e}`)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972,117],()=>r(86003));module.exports=n})();
"use strict";(()=>{var e={};e.id=4101,e.ids=[4101],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},50569:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>v,patchFetch:()=>R,requestAsyncStorage:()=>_,routeModule:()=>y,serverHooks:()=>N,staticGenerationAsyncStorage:()=>Z});var n={};o.r(n),o.d(n,{GET:()=>g,POST:()=>m});var a=o(49303),r=o(88716),i=o(60670),s=o(87070),l=o(30971),u=o(72331),c=o(92704),d=o(53524),p=o(26033);async function m(e){let t=await (0,c.So)(e);console.log("Headers:",[...e.headers.entries()]),console.log("Authenticated user:",t);try{let o;if(!t)return s.NextResponse.json({error:"ไม่พบข้อมูลผู้ใช้หรือ token ไม่ถูกต้อง"},{status:401});if(!["ORGANIZER","ADMIN"].includes(t.role))return s.NextResponse.json({error:"ไม่มีสิทธิ์เข้าถึง"},{status:403});let n=await e.json();console.log("Received body:",JSON.stringify(n,null,2));let a=l.jT.parse(n);if(a.category){let e=await u._.category.findFirst({where:{name:a.category}});if(console.log("Category searched:",a.category,"Found:",e),!e)return s.NextResponse.json({error:`ไม่พบหมวดหมู่: ${a.category}`},{status:400});o=e.id}let r=a.title.toLowerCase().replace(/[^a-z0-9ก-๙\s]/g,"").replace(/\s+/g,"-").substring(0,50)+"-"+Date.now(),i={title:a.title,description:a.description,slug:r,organizer:{connect:{id:t.id}},status:d.DonationRequestStatus.PENDING,documents:a.documents||{},images:a.images?JSON.stringify(a.images):null,urgency:a.urgency||"LOW",acceptsMoney:a.acceptsMoney||!1,acceptsItems:a.acceptsItems||!1,acceptsVolunteer:a.acceptsVolunteer||!1,targetAmount:a.targetAmount||0,itemsNeeded:a.itemsNeeded?{items:a.itemsNeeded}:null,volunteersNeeded:a.volunteersNeeded||0,volunteerSkills:a.volunteerSkills||[],volunteerDuration:a.volunteerDuration||null,address:a.address||null};o&&(i.category={connect:{id:o}});let c=await u._.donationRequest.create({data:i});return s.NextResponse.json({message:"สร้างคำขอสำเร็จ รอการอนุมัติจากผู้ดูแลระบบ",request:c})}catch(e){if(console.error("Create donation request error:",e),e instanceof p.jm)return s.NextResponse.json({error:"ข้อมูลไม่ถูกต้อง",details:e.errors},{status:400});return s.NextResponse.json({error:e.message||"เกิดข้อผิดพลาดในการสร้างคำขอ"},{status:500})}}async function g(e){try{let t=null;try{t=await (0,c.So)(e)}catch(e){console.log("No token provided, showing public donation requests")}let{searchParams:o}=new URL(e.url),n=Math.max(1,parseInt(o.get("page")||"1")),a=Math.max(1,Math.min(100,parseInt(o.get("limit")||"10"))),r=o.get("status"),i=o.get("categoryId")??void 0,l=o.get("urgency")??void 0,p=o.get("search")??void 0,m=o.get("acceptsMoney"),g=o.get("acceptsItems"),y=o.get("acceptsVolunteer"),_=r&&Object.values(d.DonationRequestStatus).includes(r)?r:void 0,Z=l&&["LOW","MEDIUM","HIGH"].includes(l)?l:void 0,N=(await u._.donationRequest.findMany({where:{status:_??d.DonationRequestStatus.APPROVED,categoryId:i||void 0,urgency:Z,title:p?{contains:p}:void 0,acceptsMoney:"true"===m||"false"!==m&&void 0,acceptsItems:"true"===g||"false"!==g&&void 0,acceptsVolunteer:"true"===y||"false"!==y&&void 0,organizerId:t?.role==="ORGANIZER"?t.id:void 0},skip:(n-1)*a,take:a,orderBy:{createdAt:"desc"},select:{id:!0,title:!0,description:!0,status:!0,targetAmount:!0,currentAmount:!0,createdAt:!0,expiresAt:!0,images:!0,category:{select:{name:!0}},donations:{select:{id:!0}},volunteerApplications:{select:{id:!0}},organizer:{select:{firstName:!0,lastName:!0}}}})).map(e=>{let t=e.donations.length+e.volunteerApplications.length,o=e.expiresAt?Math.max(0,Math.ceil((new Date(e.expiresAt).getTime()-new Date().getTime())/864e5)):0,n=[];if(e.images)try{n=Array.isArray(e.images)?e.images:JSON.parse(e.images)}catch(t){console.error(`Failed to parse images for request ${e.id}:`,t)}return{id:e.id,title:e.title,description:e.description,category:e.category.name,goalAmount:Number(e.targetAmount),currentAmount:Number(e.currentAmount),supporters:t,status:e.status.toLowerCase(),createdDate:e.createdAt.toISOString(),daysLeft:o,images:n}});return s.NextResponse.json(N)}catch(e){return console.error("Get donation requests error:",e),s.NextResponse.json({error:"เกิดข้อผิดพลาดในการดึงข้อมูลคำขอ"},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/donation-requests/route",pathname:"/api/donation-requests",filename:"route",bundlePath:"app/api/donation-requests/route"},resolvedPagePath:"D:\\testProject\\test-project\\app\\api\\donation-requests\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:_,staticGenerationAsyncStorage:Z,serverHooks:N}=y,v="/api/donation-requests/route";function R(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:Z})}},90455:(e,t,o)=>{o.d(t,{Gv:()=>l,RA:()=>u,WX:()=>c,c_:()=>s});var n=o(98691),a=o(41482),r=o.n(a);let i=process.env.JWT_SECRET||"your-secret-key";async function s(e){return n.ZP.hash(e,12)}async function l(e,t){return n.ZP.compare(e,t)}function u(e){let t={id:e.id,email:e.email,role:e.role,firstName:e.firstName,lastName:e.lastName,organizationId:e.organizationId},o=r().sign(t,i,{expiresIn:"7d"});return console.log("Generated token payload:",t),console.log("Generated token:",o),o}function c(e){try{let t=r().verify(e,i);return console.log("Decoded token:",t),t}catch(e){return console.error("Token verification failed:",e.message),null}}},92704:(e,t,o)=>{o.d(t,{So:()=>i,lj:()=>r});var n=o(87070),a=o(90455);async function r(e){let t=e.headers.get("authorization")?.replace("Bearer ","")||e.cookies.get("auth-token")?.value;if(!t)return n.NextResponse.json({error:"ไม่พบ token การยืนยันตัวตน"},{status:401});let o=await (0,a.WX)(t);if(!o)return n.NextResponse.json({error:"Token ไม่ถูกต้องหรือหมดอายุ"},{status:401});let r=new Headers(e.headers);return r.set("x-user-id",o.id),r.set("x-user-role",o.role),n.NextResponse.next({request:{headers:r}})}async function i(e){let t=e.headers.get("authorization")?.replace("Bearer ","")||e.cookies.get("auth-token")?.value;if(!t)return console.log("No token provided"),null;let o=await (0,a.WX)(t);return console.log("Authenticated user:",o),o||null}},72331:(e,t,o)=>{o.d(t,{_:()=>a});var n=o(53524);let a=globalThis.prisma??new n.PrismaClient},30971:(e,t,o)=>{o.d(t,{K3:()=>i,Pc:()=>c,dm:()=>r,g2:()=>u,gY:()=>d,jT:()=>l,lp:()=>s});var n=o(91585),a=o(53524);let r=n.Ry({email:n.Z_().email("อีเมลไม่ถูกต้อง"),password:n.Z_().min(1,"กรุณากรอกรหัสผ่าน")}),i=n.Ry({requestId:n.Z_().min(1,"กรุณาเลือกคำขอ"),amount:n.Rx().positive("จำนวนเงินต้องมากกว่า 0"),message:n.Z_().optional(),anonymous:n.O7().default(!1),paymentMethod:n.Z_().min(1,"กรุณาเลือกวิธีการชำระเงิน")}),s=n.Ry({requestId:n.Z_().min(1,"กรุณาเลือกคำขอ"),message:n.Z_().min(10,"ข้อความต้องมีอย่างน้อย 10 ตัวอักษร"),skills:n.Z_().optional(),experience:n.Z_().optional(),availability:n.Z_().optional(),hoursCommitted:n.Rx().positive().optional()});n.Ry({title:n.Z_().min(1,"กรุณากรอกหัวข้อ"),content:n.Z_().min(50,"เนื้อหาต้องมีอย่างน้อย 50 ตัวอักษร"),requestId:n.Z_().optional(),images:n.IX(n.Z_()).default([])});let l=n.Ry({title:n.Z_().min(1,"ต้องระบุหัวข้อ"),description:n.Z_().min(1,"ต้องระบุรายละเอียด"),category:n.Z_().min(1,"ต้องระบุหมวดหมู่"),address:n.Z_().nullable(),urgency:n.Km(["LOW","MEDIUM","HIGH","URGENT"]).optional().default("LOW"),acceptsMoney:n.O7().optional().default(!1),acceptsItems:n.O7().optional().default(!1),acceptsVolunteer:n.O7().optional().default(!1),targetAmount:n.Rx().optional().default(0),itemsNeeded:n.IX(n.Z_()).optional().nullable(),volunteersNeeded:n.Rx().int().min(0).optional().default(0),volunteerSkills:n.IX(n.Z_()).optional().default([]),volunteerDuration:n.Z_().nullable(),images:n.IX(n.Z_().url()).optional().default([]),documents:n.Ry({detailedAddress:n.Z_().nullable(),contactPhone:n.Z_().nullable(),bankAccount:n.Ry({bank:n.Z_().optional(),accountNumber:n.Z_().optional(),accountName:n.Z_().optional()}).optional(),organizationDetails:n.Ry({organizationType:n.Z_().optional(),registrationNumber:n.Z_().optional(),taxId:n.Z_().optional()}).optional()}).optional()}),u=n.Ry({title:n.Z_().optional(),description:n.Z_().optional(),categoryId:n.Z_().optional(),targetAmount:n.Rx().optional(),address:n.Z_().optional(),urgency:n.Km(["LOW","MEDIUM","HIGH"]).optional(),acceptsMoney:n.O7().optional(),acceptsItems:n.O7().optional(),acceptsVolunteer:n.O7().optional(),itemsNeeded:n.IX(n.Z_()).optional(),volunteersNeeded:n.Rx().optional(),volunteerSkills:n.IX(n.Z_()).optional(),volunteerDuration:n.Z_().optional(),images:n.IX(n.Z_()).optional(),documents:n.IM(n.Z_(),n.Yj()).optional(),status:n.Km(["PENDING","COMPLETED","CANCELLED","DRAFT","APPROVED","REJECTED"]).optional(),expiresAt:n.Z_().datetime().optional()}),c=n.Ry({email:n.Z_().email("กรุณาระบุอีเมลที่ถูกต้อง"),password:n.Z_().min(8,"รหัสผ่านต้องมีอย่างน้อย 8 ตัวอักษร"),firstName:n.Z_().min(1,"กรุณาระบุชื่อ"),lastName:n.Z_().min(1,"กรุณาระบุนามสกุล"),phone:n.Z_().min(10,"กรุณาระบุหมายเลขโทรศัพท์ที่ถูกต้อง").regex(/^\d{10}$/,"หมายเลขโทรศัพท์ต้องมี 10 หลัก"),role:n.jb(a.user_role,{errorMap:()=>({message:"กรุณาระบุบทบาท"})}),organizationId:n.Z_().optional(),newOrganizationName:n.Z_().optional(),organizationType:n.jb(a.organization_type,{errorMap:()=>({message:"กรุณาระบุประเภทองค์กรที่ถูกต้อง"})}).optional(),registrationNumber:n.Z_().optional(),templeId:n.Z_().optional(),interests:n.IX(n.Z_()).optional(),bio:n.Z_().optional(),documents:n.Ry({idCard:n.Yj().optional(),organizationCert:n.Yj().optional()}).optional()}),d=c.refine(e=>"ORGANIZER"!==e.role||e.organizationId&&"other"!==e.organizationId||e.newOrganizationName&&e.organizationType,{message:"กรุณาระบุข้อมูลองค์กรให้ครบถ้วน (ต้องมี newOrganizationName และ organizationType) สำหรับผู้จัดงาน",path:["organizationId","organizationType"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),n=t.X(0,[9276,5972,1482,8691,1585],()=>o(50569));module.exports=n})();
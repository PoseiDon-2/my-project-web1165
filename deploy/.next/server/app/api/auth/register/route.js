"use strict";(()=>{var e={};e.id=3002,e.ids=[3002],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},29196:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>x,serverHooks:()=>j,staticGenerationAsyncStorage:()=>z});var a={};r.r(a),r.d(a,{POST:()=>N});var i=r(49303),o=r(88716),n=r(60670),s=r(87070),u=r(30971),p=r(24544),l=r(90455);let d=(0,r(68570).createProxy)(String.raw`D:\testProject\test-project\lib\storage.ts#uploadFileToCloudinary`);var g=r(53524),m=r(72331);global.otpStore||(global.otpStore=new Map);let c=global.otpStore,f={ngo:g.organization_type.NGO,charity:g.organization_type.CHARITY,foundation:g.organization_type.FOUNDATION,government:g.organization_type.GOVERNMENT,temple:g.organization_type.TEMPLE,other:g.organization_type.OTHER};async function N(e){try{let t,r;let a=await e.formData(),i=Object.fromEntries(a),o=await u.gY.parseAsync({...i,interests:i.interests?JSON.parse(i.interests):void 0,documents:{idCard:a.get("idCard"),organizationCert:a.get("organizationCert")}}),n=c.get(o.email);if(!n||Date.now()>n.expiresAt)return s.NextResponse.json({error:"อีเมลนี้ยังไม่ได้ยืนยัน"},{status:400});if(await p.W4.findByEmail(o.email))return s.NextResponse.json({error:"อีเมลนี้ถูกใช้งานแล้ว"},{status:400});let N=o.organizationId;if("ORGANIZER"===o.role){if(o.organizationId&&"other"!==o.organizationId){let e=await p.uK.findById(o.organizationId);if(!e)return s.NextResponse.json({error:"ไม่พบองค์กรที่เลือก"},{status:400});N=e.id,await p.uK.update(e.id,{registrationNumber:o.registrationNumber||null,templeId:o.templeId||null})}else{if(!o.newOrganizationName)return s.NextResponse.json({error:"กรุณาระบุข้อมูลองค์กรให้ครบถ้วน"},{status:400});if(!o.organizationType)return s.NextResponse.json({error:"ต้องระบุประเภทองค์กรเมื่อสร้างองค์กรใหม่"},{status:400});let e=f[o.organizationType.toLowerCase()];if(!e||!Object.values(g.organization_type).includes(e))return s.NextResponse.json({error:`ประเภทองค์กรไม่ถูกต้อง: ${o.organizationType}`},{status:400});N=(await p.uK.create({name:o.newOrganizationName,type:e,registrationNumber:o.registrationNumber||null,templeId:o.templeId||null,phone:null,address:null,website:null})).id}}if(o.documents?.idCard){if(o.documents.idCard.size>5242880)return s.NextResponse.json({error:"ไฟล์บัตรประจำตัวใหญ่เกิน 5MB"},{status:400});if(!["image/jpeg","image/png","application/pdf"].includes(o.documents.idCard.type))return s.NextResponse.json({error:"ประเภทไฟล์บัตรประจำตัวไม่ถูกต้อง (ต้องเป็น JPEG, PNG, หรือ PDF)"},{status:400});t=await d(o.documents.idCard,`idCard-${o.email}-${Date.now()}`)}if(o.documents?.organizationCert){if(o.documents.organizationCert.size>5242880)return s.NextResponse.json({error:"ไฟล์เอกสารองค์กรใหญ่เกิน 5MB"},{status:400});if(!["image/jpeg","image/png","application/pdf"].includes(o.documents.organizationCert.type))return s.NextResponse.json({error:"ประเภทไฟล์เอกสารองค์กรไม่ถูกต้อง (ต้องเป็น JPEG, PNG, หรือ PDF)"},{status:400});r=await d(o.documents.organizationCert,`orgCert-${o.email}-${Date.now()}`)}let x=await (0,l.c_)(o.password),y={id:crypto.randomUUID(),updatedAt:new Date,email:o.email,password:x,firstName:o.firstName,lastName:o.lastName,phone:o.phone,bio:o.bio??null,role:o.role,idCardUrl:t??null,organizationCertUrl:r??null,isEmailVerified:!0,documentsVerified:"ORGANIZER"!==o.role,...N&&{organization:{connect:{id:N}}}},z=await p.W4.create(y);o.interests&&o.interests.length>0&&await m._.userinterest.createMany({data:o.interests.map(e=>({userId:z.id,interestId:e})),skipDuplicates:!0});let j=(0,l.RA)({id:z.id,email:z.email,firstName:z.firstName||"",lastName:z.lastName||"",role:z.role,organizationId:z.organizationId||void 0});c.delete(o.email);let{password:R,...w}=z;return s.NextResponse.json({message:"สมัครสมาชิกสำเร็จ",user:w,token:j})}catch(e){if(console.error("Registration error:",e),"ZodError"===e.name)return s.NextResponse.json({error:"ข้อมูลไม่ถูกต้อง",details:e.errors},{status:400});return s.NextResponse.json({error:"เกิดข้อผิดพลาดในการสมัครสมาชิก"},{status:500})}}let x=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"D:\\testProject\\test-project\\app\\api\\auth\\register\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:z,serverHooks:j}=x,R="/api/auth/register/route";function w(){return(0,n.patchFetch)({serverHooks:j,staticGenerationAsyncStorage:z})}},68570:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"createProxy",{enumerable:!0,get:function(){return a}});let a=r(51749).createClientModuleProxy},51749:(e,t,r)=>{e.exports=r(23191).vendored["react-rsc"].ReactServerDOMWebpackServerEdge}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972,1482,8691,1585,603],()=>r(29196));module.exports=a})();
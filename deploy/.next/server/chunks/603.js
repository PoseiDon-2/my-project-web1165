"use strict";exports.id=603,exports.ids=[603],exports.modules={90455:(e,t,a)=>{a.d(t,{Gv:()=>l,RA:()=>d,WX:()=>u,c_:()=>s});var o=a(98691),n=a(41482),i=a.n(n);let r=process.env.JWT_SECRET||"your-secret-key";async function s(e){return o.ZP.hash(e,12)}async function l(e,t){return o.ZP.compare(e,t)}function d(e){let t={id:e.id,email:e.email,role:e.role,firstName:e.firstName,lastName:e.lastName,organizationId:e.organizationId},a=i().sign(t,r,{expiresIn:"7d"});return console.log("Generated token payload:",t),console.log("Generated token:",a),a}function u(e){try{let t=i().verify(e,r);return console.log("Decoded token:",t),t}catch(e){return console.error("Token verification failed:",e.message),null}}},24544:(e,t,a)=>{a.d(t,{TX:()=>d,W4:()=>r,cm:()=>s,sK:()=>l,uK:()=>c,zl:()=>u});var o=a(72331),n=a(53524),i=a(30971);let r={create:async e=>o._.user.create({data:e}),findByEmail:async e=>o._.user.findUnique({where:{email:e},include:{donationRequests:!0,donations:!0,volunteerApplications:!0}}),findById:async e=>o._.user.findUnique({where:{id:e},include:{donationRequests:{include:{donations:!0,volunteerApplications:!0}},donations:{include:{request:!0}},volunteerApplications:{include:{request:!0}}}}),update:async(e,t)=>o._.user.update({where:{id:e},data:t}),async getAll(e=1,t=10,a){let n=a?{role:a}:{},[i,r]=await Promise.all([o._.user.findMany({where:n,skip:(e-1)*t,take:t,orderBy:{createdAt:"desc"},select:{id:!0,email:!0,firstName:!0,lastName:!0,role:!0,status:!0,createdAt:!0,_count:{select:{donationRequests:!0,donations:!0,volunteerApplications:!0}}}}),o._.user.count({where:n})]);return{users:i,pagination:{page:e,limit:t,total:r,pages:Math.ceil(r/t)}}}},s={async findById(e){let t=await o._.donationRequest.findUnique({where:{id:e},select:{id:!0,title:!0,description:!0,category:{select:{id:!0,name:!0}},targetAmount:!0,currentAmount:!0,supporters:!0,status:!0,createdAt:!0,expiresAt:!0,images:!0,itemsNeeded:!0,volunteersNeeded:!0,volunteerSkills:!0,volunteerDuration:!0,organizer:{select:{id:!0,phone:!0}},organizerId:!0,donations:{select:{id:!0,amount:!0,itemDetails:!0,type:!0,status:!0,createdAt:!0,donor:{select:{firstName:!0,lastName:!0,phone:!0,email:!0}}}},viewCount:!0,acceptsMoney:!0,acceptsItems:!0,acceptsVolunteer:!0,location:!0,urgency:!0,documents:!0}});if(!t)return null;let a=(t,a)=>{if(!t)return[];if(Array.isArray(t))return t;if("string"!=typeof t)return console.warn(`Invalid ${a} format in request ${e}: Expected string or array, got ${typeof t}`),[];try{let e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return console.error(`Failed to parse ${a} for request ${e}:`,t),[]}};return{...t,category:t.category?.name||"N/A",categoryId:t.category?.id,createdDate:t.createdAt.toISOString(),daysLeft:t.expiresAt?Math.max(0,Math.ceil((t.expiresAt.getTime()-Date.now())/864e5)):0,images:a(t.images,"images"),itemsNeeded:a(t.itemsNeeded,"itemsNeeded"),volunteerSkills:a(t.volunteerSkills,"volunteerSkills"),volunteerDuration:t.volunteerDuration||null,documents:a(t.documents,"documents")||{},donations:t.donations.map(e=>({...e,donorName:e.donor?`${e.donor.firstName||""} ${e.donor.lastName||""}`.trim():"N/A",donorPhone:e.donor?.phone||"N/A",donorEmail:e.donor?.email||"N/A",itemDetails:a(e.itemDetails,"itemDetails")||null}))}},async incrementViewCount(e){try{await o._.donationRequest.update({where:{id:e},data:{viewCount:{increment:1}}})}catch(t){throw console.error(`Increment view count error for request ${e}:`,t),t}},async update(e,t){let a=i.g2.safeParse(t);if(!a.success)throw Error(`Invalid input: ${JSON.stringify(a.error.errors)}`);let n=a.data,r={};void 0!==n.title&&(r.title=n.title),void 0!==n.description&&(r.description=n.description),void 0!==n.categoryId&&(r.categoryId=n.categoryId),void 0!==n.address&&(r.location=n.address),void 0!==n.urgency&&(r.urgency=n.urgency),void 0!==n.acceptsMoney&&(r.acceptsMoney=n.acceptsMoney),void 0!==n.acceptsItems&&(r.acceptsItems=n.acceptsItems),void 0!==n.acceptsVolunteer&&(r.acceptsVolunteer=n.acceptsVolunteer),void 0!==n.targetAmount&&(r.targetAmount=n.targetAmount),void 0!==n.itemsNeeded&&(r.itemsNeeded=n.itemsNeeded?JSON.stringify(n.itemsNeeded):null),void 0!==n.volunteersNeeded&&(r.volunteersNeeded=n.volunteersNeeded),void 0!==n.volunteerSkills&&(r.volunteerSkills=n.volunteerSkills?JSON.stringify(n.volunteerSkills):null),void 0!==n.volunteerDuration&&(r.volunteerDuration=n.volunteerDuration),void 0!==n.images&&(r.images=n.images?JSON.stringify(n.images):null),void 0!==n.documents&&(r.documents=n.documents?JSON.stringify(n.documents):null),void 0!==n.status&&(r.status=n.status),void 0!==n.expiresAt&&(r.expiresAt=n.expiresAt?new Date(n.expiresAt):null);try{let t=await o._.donationRequest.update({where:{id:e},data:r,select:{id:!0,title:!0,description:!0,category:{select:{id:!0,name:!0}},targetAmount:!0,currentAmount:!0,supporters:!0,status:!0,createdAt:!0,expiresAt:!0,images:!0,itemsNeeded:!0,volunteersNeeded:!0,volunteerSkills:!0,volunteerDuration:!0,organizer:{select:{id:!0,phone:!0}},organizerId:!0,donations:{select:{id:!0,amount:!0,itemDetails:!0,type:!0,status:!0,createdAt:!0,donor:{select:{firstName:!0,lastName:!0,phone:!0,email:!0}}}},viewCount:!0,acceptsMoney:!0,acceptsItems:!0,acceptsVolunteer:!0,location:!0,urgency:!0,documents:!0}}),a=(t,a)=>{if(!t)return[];if(Array.isArray(t))return t;if("string"!=typeof t)return console.warn(`Invalid ${a} format in request ${e}: Expected string or array, got ${typeof t}`),[];try{let e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return console.error(`Failed to parse ${a} for request ${e}:`,t),[]}};return{...t,category:t.category?.name||"N/A",categoryId:t.category?.id,createdDate:t.createdAt.toISOString(),daysLeft:t.expiresAt?Math.max(0,Math.ceil((t.expiresAt.getTime()-Date.now())/864e5)):0,images:a(t.images,"images"),itemsNeeded:a(t.itemsNeeded,"itemsNeeded"),volunteerSkills:a(t.volunteerSkills,"volunteerSkills"),volunteerDuration:t.volunteerDuration||null,documents:a(t.documents,"documents")||{},donations:t.donations.map(e=>({...e,donorName:e.donor?`${e.donor.firstName||""} ${e.donor.lastName||""}`.trim():"N/A",donorPhone:e.donor?.phone||"N/A",donorEmail:e.donor?.email||"N/A",itemDetails:a(e.itemDetails,"itemDetails")||null}))}}catch(t){throw console.error(`Update donation request error for request ${e}:`,t),t}},async delete(e){try{return await o._.donationRequest.delete({where:{id:e}}),{message:"ลบคำขอบริจาคสำเร็จ"}}catch(t){throw console.error(`Delete donation request error for request ${e}:`,t),t}}},l={create:async e=>o._.$transaction(async t=>{if(e.type===n.DonationType.ITEMS&&e.itemDetails)try{"string"==typeof e.itemDetails?JSON.parse(e.itemDetails):e.itemDetails=JSON.stringify(e.itemDetails)}catch(t){throw console.error("Invalid itemDetails format for donation creation:",t,"Raw data:",e.itemDetails),Error("itemDetails must be a valid JSON string or object")}let a=await t.donation.create({data:e,include:{donor:{select:{id:!0,firstName:!0,lastName:!0,avatar:!0}},request:{select:{id:!0,title:!0,organizerId:!0}}}});return e.type===n.DonationType.MONEY&&"number"==typeof e.amount&&await t.donationRequest.update({where:{id:a.requestId},data:{currentAmount:{increment:e.amount}}}),a}),async findById(e){let t=await o._.donation.findUnique({where:{id:e},include:{donor:{select:{id:!0,firstName:!0,lastName:!0,avatar:!0}},request:{select:{id:!0,title:!0,organizer:{select:{id:!0,firstName:!0,lastName:!0}}}}}});return t?{...t,itemDetails:((t,a)=>{if(!t||"string"!=typeof t)return t;try{return JSON.parse(t)}catch(o){return console.error(`Failed to parse ${a} for donation ${e}:`,o,"Raw data:",t),t}})(t.itemDetails,"itemDetails")}:null},async getByUser(e,t=1,a=10){let[n,i]=await Promise.all([o._.donation.findMany({where:{donorId:e},skip:(t-1)*a,take:a,orderBy:{createdAt:"desc"},include:{request:{select:{id:!0,title:!0,categoryId:!0,images:!0}}}}),o._.donation.count({where:{donorId:e}})]),r=(e,t,a)=>{if(!e||"string"!=typeof e)return e;try{return JSON.parse(e)}catch(o){return console.error(`Failed to parse ${t} for donation ${a}:`,o,"Raw data:",e),e}};return{donations:n.map(e=>({...e,itemDetails:r(e.itemDetails,"itemDetails",e.id)})),pagination:{page:t,limit:a,total:i,pages:Math.ceil(i/a)}}},updateStatus:async(e,t)=>o._.donation.update({where:{id:e},data:{status:t,completedAt:t===n.DonationStatus.COMPLETED?new Date:null}})},d={create:async e=>o._.$transaction(async t=>{let a=await t.volunteerApplication.create({data:e,include:{volunteer:{select:{id:!0,firstName:!0,lastName:!0,avatar:!0}},request:{select:{id:!0,title:!0,organizerId:!0}}}});return await t.donationRequest.update({where:{id:a.requestId},data:{volunteersReceived:{increment:1}}}),a}),findById:async e=>o._.volunteerApplication.findUnique({where:{id:e},include:{volunteer:{select:{id:!0,firstName:!0,lastName:!0,avatar:!0,phone:!0,bio:!0}},request:{select:{id:!0,title:!0,organizer:{select:{id:!0,firstName:!0,lastName:!0}}}}}}),getByRequest:async e=>o._.volunteerApplication.findMany({where:{requestId:e},orderBy:{createdAt:"desc"},include:{volunteer:{select:{id:!0,firstName:!0,lastName:!0,avatar:!0,phone:!0,bio:!0}}}}),updateStatus:async(e,t)=>o._.volunteerApplication.update({where:{id:e},data:{status:t,approvedAt:t===n.VolunteerStatus.APPROVED?new Date:null,completedAt:t===n.VolunteerStatus.COMPLETED?new Date:null}})},u={async toggle(e,t){let a=await o._.favorite.findUnique({where:{userId_requestId:{userId:e,requestId:t}}});return a?(await o._.favorite.delete({where:{id:a.id}}),{action:"removed"}):(await o._.favorite.create({data:{userId:e,requestId:t}}),{action:"added"})},async getByUser(e,t=1,a=10){let[n,i]=await Promise.all([o._.favorite.findMany({where:{userId:e},skip:(t-1)*a,take:a,orderBy:{createdAt:"desc"},include:{request:{include:{organizer:{select:{id:!0,firstName:!0,lastName:!0}},_count:{select:{donations:!0,volunteerApplications:!0}}}}}}),o._.favorite.count({where:{userId:e}})]);return{favorites:n.map(e=>e.request),pagination:{page:t,limit:a,total:i,pages:Math.ceil(i/a)}}}},c={findById:async e=>o._.organization.findUnique({where:{id:e}}),create:async e=>o._.organization.create({data:{...e,id:crypto.randomUUID(),updatedAt:new Date}}),update:async(e,t)=>o._.organization.update({where:{id:e},data:t})}},72331:(e,t,a)=>{a.d(t,{_:()=>n});var o=a(53524);let n=globalThis.prisma??new o.PrismaClient},30971:(e,t,a)=>{a.d(t,{K3:()=>r,Pc:()=>u,dm:()=>i,g2:()=>d,gY:()=>c,jT:()=>l,lp:()=>s});var o=a(91585),n=a(53524);let i=o.Ry({email:o.Z_().email("อีเมลไม่ถูกต้อง"),password:o.Z_().min(1,"กรุณากรอกรหัสผ่าน")}),r=o.Ry({requestId:o.Z_().min(1,"กรุณาเลือกคำขอ"),amount:o.Rx().positive("จำนวนเงินต้องมากกว่า 0"),message:o.Z_().optional(),anonymous:o.O7().default(!1),paymentMethod:o.Z_().min(1,"กรุณาเลือกวิธีการชำระเงิน")}),s=o.Ry({requestId:o.Z_().min(1,"กรุณาเลือกคำขอ"),message:o.Z_().min(10,"ข้อความต้องมีอย่างน้อย 10 ตัวอักษร"),skills:o.Z_().optional(),experience:o.Z_().optional(),availability:o.Z_().optional(),hoursCommitted:o.Rx().positive().optional()});o.Ry({title:o.Z_().min(1,"กรุณากรอกหัวข้อ"),content:o.Z_().min(50,"เนื้อหาต้องมีอย่างน้อย 50 ตัวอักษร"),requestId:o.Z_().optional(),images:o.IX(o.Z_()).default([])});let l=o.Ry({title:o.Z_().min(1,"ต้องระบุหัวข้อ"),description:o.Z_().min(1,"ต้องระบุรายละเอียด"),category:o.Z_().min(1,"ต้องระบุหมวดหมู่"),address:o.Z_().nullable(),urgency:o.Km(["LOW","MEDIUM","HIGH","URGENT"]).optional().default("LOW"),acceptsMoney:o.O7().optional().default(!1),acceptsItems:o.O7().optional().default(!1),acceptsVolunteer:o.O7().optional().default(!1),targetAmount:o.Rx().optional().default(0),itemsNeeded:o.IX(o.Z_()).optional().nullable(),volunteersNeeded:o.Rx().int().min(0).optional().default(0),volunteerSkills:o.IX(o.Z_()).optional().default([]),volunteerDuration:o.Z_().nullable(),images:o.IX(o.Z_().url()).optional().default([]),documents:o.Ry({detailedAddress:o.Z_().nullable(),contactPhone:o.Z_().nullable(),bankAccount:o.Ry({bank:o.Z_().optional(),accountNumber:o.Z_().optional(),accountName:o.Z_().optional()}).optional(),organizationDetails:o.Ry({organizationType:o.Z_().optional(),registrationNumber:o.Z_().optional(),taxId:o.Z_().optional()}).optional()}).optional()}),d=o.Ry({title:o.Z_().optional(),description:o.Z_().optional(),categoryId:o.Z_().optional(),targetAmount:o.Rx().optional(),address:o.Z_().optional(),urgency:o.Km(["LOW","MEDIUM","HIGH"]).optional(),acceptsMoney:o.O7().optional(),acceptsItems:o.O7().optional(),acceptsVolunteer:o.O7().optional(),itemsNeeded:o.IX(o.Z_()).optional(),volunteersNeeded:o.Rx().optional(),volunteerSkills:o.IX(o.Z_()).optional(),volunteerDuration:o.Z_().optional(),images:o.IX(o.Z_()).optional(),documents:o.IM(o.Z_(),o.Yj()).optional(),status:o.Km(["PENDING","COMPLETED","CANCELLED","DRAFT","APPROVED","REJECTED"]).optional(),expiresAt:o.Z_().datetime().optional()}),u=o.Ry({email:o.Z_().email("กรุณาระบุอีเมลที่ถูกต้อง"),password:o.Z_().min(8,"รหัสผ่านต้องมีอย่างน้อย 8 ตัวอักษร"),firstName:o.Z_().min(1,"กรุณาระบุชื่อ"),lastName:o.Z_().min(1,"กรุณาระบุนามสกุล"),phone:o.Z_().min(10,"กรุณาระบุหมายเลขโทรศัพท์ที่ถูกต้อง").regex(/^\d{10}$/,"หมายเลขโทรศัพท์ต้องมี 10 หลัก"),role:o.jb(n.user_role,{errorMap:()=>({message:"กรุณาระบุบทบาท"})}),organizationId:o.Z_().optional(),newOrganizationName:o.Z_().optional(),organizationType:o.jb(n.organization_type,{errorMap:()=>({message:"กรุณาระบุประเภทองค์กรที่ถูกต้อง"})}).optional(),registrationNumber:o.Z_().optional(),templeId:o.Z_().optional(),interests:o.IX(o.Z_()).optional(),bio:o.Z_().optional(),documents:o.Ry({idCard:o.Yj().optional(),organizationCert:o.Yj().optional()}).optional()}),c=u.refine(e=>"ORGANIZER"!==e.role||e.organizationId&&"other"!==e.organizationId||e.newOrganizationName&&e.organizationType,{message:"กรุณาระบุข้อมูลองค์กรให้ครบถ้วน (ต้องมี newOrganizationName และ organizationType) สำหรับผู้จัดงาน",path:["organizationId","organizationType"]})}};